---
title: "A Survey of the Impact of COVID-19 and Current Vacination Status in Sweden"
description: |
  A short description of the post.
categories:
  - COVID-19
author:
  - name: Jaffie Yang
    url: https://etc5523-2021.github.io/blog-myan0065/about.html
    affiliation: Monash NUMBATs
    affiliation_url: https://numbat.space/
date: 09-12-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      out.width = "80%",
                      fig.align = "center")
```

```{r package}
library(readxl)
library(here)
library(ggplot2)
library(treemapify)
library(patchwork)
library(dplyr)
library(tidyverse)
library(tidytext)
library(lubridate)
library(naniar)
library(kableExtra)
library(plotly)
library(DT)
library(scales)
```

```{r read-data}
vacc_se <- read_csv(here("data/data_se.csv"))
surv_se <- read_csv(here("data/wdata_COVID_2207.csv"))
surv_dict <- read_excel(here("data/Codebook_2207.xlsx"), sheet = 2, range = "b1:d40")
```

## Introduction 

In this post, we will continue to explore the COVID status in Europe, but in a different country, Sweden. Two key topics will be addressed.

## Data Description üìÑ

### COVID -19 Survey Data

This survey data is obtained from <a href=https://covid19dataportal.se/data_types/all/data/> Swedish COVID-19 Data Portal</a>, it is publicly accessible and under MIT license. It is a survey done by 40,060 people from `r length(unique(surv_se$country_label))` different European countries, all the entries were done between April to July in 2020 when COVID-19 hit Europe. There are `r ncol(surv_se)` variables and `r nrow(surv_se)` observations, data dictionary and missing values are shown in Figure \@ref(fig:surv-dict) and Figure \@ref(fig:surv-miss).

```{r surv-dict, fig.cap = "COVID-19 Survey 2020, Europe"}
surv_dict %>% 
  datatable(options = list(pageLength = 6,
                            columnDefs = list(list(className = 'dt-left', targets = 1:3))),
            colnames = c("Variable", "Original Question / Description", "Value Labels"),
            caption = "Data Dictionary")
```
```{r surv-miss, fig.cap = "Summary of Missing Value in COVID-19 Survey Data"}
surv_se %>% 
  filter(country_label == "Sweden") %>% 
miss_var_summary() %>% 
    datatable(options = list(pageLength = 5,
                            columnDefs = list(list(className = 'dt-center', targets = 2:3))),
            caption = "Missing Values in Each Variable",
            colnames = c("Variable", "Number of Missing", "Percentage of Missing"))
```


### Vaccination Data
Dataset used in the post was sourced from <a href=https://www.ecdc.europa.eu/en/publications-data/data-covid-19-vaccination-eu-eea> European Centre for Disease Prevention and Control</a>, it provides open source data for infectious diseases. This dataset contains vaccination data for `r length(unique(vacc_se$ReportingCountry))` European countries, there are `r ncol(vacc_se)` variables and `r nrow(vacc_se)` observations and all data are up to date, data dictionary is shown in Figure \@ref(fig:vacc).

```{r vacc, fig.cap = "Data Dictionary"}
tribble(
  ~Variable, ~Class, ~Description,
  #---|----|--------------
  "YearWeekISO", "Character", "Date when the vaccine was administered. Only weeks are allowed (e.g. ‚Äú2021-W01‚Äù).",
  "FirstDose", "Numeric", "Number of first dose vaccine administered to individuals during the reporting week.",
  "FirstDoseRefused", "Numeric", "Number of individuals refusing the first vaccine dose.",
  "SeconDose", "Numeric", "Number of second dose vaccine administered to individuals during the reporting week.",
  "Unknown Dose", "Numeric", "Number of doses administered during the reporting week where the type of dose (first or second) was not specified.",
  "NumberDosesReceived", "Numeric", "Number of vaccine doses distributed by the manufacturers to the country during the reporting week.",
  "Region", "Character", "Country code",
  "Polulation", "Numeric", "Age-specific population for the country",
  "Reporting Country", "Character", "Two-letter county code",
  "Target Group","Character", "Target group for vaccination. ‚ÄúALL‚Äù for the overall figures, ‚ÄúHCW‚Äù for healthcare workers and age-groups.",
  "Vaccine", "Charater", "Name of vaccine. AZ = AstraZeneca, BECNBG (previously CN) = Beijing CNBG, BHACOV = Bharat, COM = Pfizer/BioNTech, JANSS = Janssen, HAYATVAC = Hayat VAC, MOD = Moderna, QAZVAQ = QazCovid-In, SIICOV = Covishield ‚Äì SII, SIN = Sinovac, SPU = Sputnik V - Gamaleya, SRCVB = EpiVacCorona ‚Äì SRCVB, WUCNBG = Inactivated ‚Äì Wuhan CNBG, UNK = UNKNOWN, ZFUZ = Sino-Uzbek - ZF-UZVAC",
  "Denominator", "Numeric", "Population denominators for target groups.") %>% 
    datatable(options = list(pageLength = 6,
                            columnDefs = list(list(className = 'dt-left', targets = 1:3))),
            caption = "Data Dictionary")
```
This post mainly focuses on analysing the data for Sweden, Figure \@ref(fig:missing) shows the number of missing values and their percentage in each variable in the sub-dataset of Sweden. Variable FirstDoseRefused and Denominator will not be used for the analysis and they can be omitted. As the number of vaccine doses distributed to the country were not on a weekly basis, therefore there are 94% of missing values.

```{r missing, fig.cap = "Summary of Missing Value in Sub-dataset for Sweden"}
vacc_se %>% 
  filter(ReportingCountry == "SE") %>% 
miss_var_summary() %>% 
    datatable(options = list(pageLength = 5,
                            columnDefs = list(list(className = 'dt-center', targets = 2:3))),
            caption = "Missing Values in Each Variable",
            colnames = c("Variable", "Number of Missing", "Percentage of Missing"))
```

## Data Exploration üîç

### COVID-19 Survey

```{r surv-cleaning}
surv_long <- surv_se %>% 
  select(!c(1:6, "audit_sum", "country", "week", "weight", "popweight")) %>% 
  relocate(change_income, .after = consumer) %>% 
  mutate(diagnose = as.character(diagnose),
         sex = as.character(sex)) %>% 
  pivot_longer(cols = "change_income":"change_illdrugs",
               names_to = "covid_survey",
               values_to = "score")

surv_long_se <- surv_long %>% 
    filter(country_label == "Sweden")
  
```

#### Mental Health

```{r}
surv_long_se$agegr[surv_long_se$agegr == "1"] <- "18-34 years"
surv_long_se$agegr[surv_long_se$agegr == "2"] <- "35-54 years"
surv_long_se$agegr[surv_long_se$agegr == "3"] <- "55-98 years"

n1 <- surv_se %>% 
  filter(country_label == "Sweden",
         agegr == "1") %>% 
  count()

n2 <- surv_se %>% 
  filter(country_label == "Sweden",
         agegr == "2") %>% 
  count()

n3 <- n2 <- surv_se %>% 
  filter(country_label == "Sweden",
         agegr == "3") %>% 
  count()

newcol <- c(0.67, 0.31, 0.68, 0.32, 0.64, 0.36)

newcol <- percent(newcol, 1)

df <- surv_long_se %>% 
  filter(covid_survey == "distress") %>% 
  group_by(agegr, score) %>% 
  summarise(count = n()) 

df$pct <- newcol

df %>% 
  ggplot(aes(x = agegr,
             y = count,
             fill = score)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_manual(values = c("#fc8d62", "#66c2a5"),
                    labels = c("Yes", "No")) +
  scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = pct), 
            position = position_fill(vjust = 0.5),
            size = 3,
            colour = "white") +
  theme_light() +
  labs(x = "Age Group",
       y = "Percentage",
       fill = "Answer",
       title = "Have you found the spread of COVID-19 stressful?",
       subtitle = "Year: 2020",
       caption = "Data Source: Swedish COVID-19 Data Portal") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0))

# ggplotly(plot1) %>% 
#     layout(title = list(text = paste0("Have you found the spread of COVID-19 stressful?",
#                                     "<br>",
#                                     "<sup>",
#                                     "Year: 2020",
#                                     "</sup>")),
#            annotations = list(x = 1, y = -5.4, 
#                               text = "Data Source: Swedish COVID-19 Data Portal",
#                               xref='paper',
#                               showarrow = F,
#                               font=list(size=6)))
```

#### Financial Status
```{r}
surv_long_se$residence[surv_long_se$residence == "1"] <- "Village/fram"
surv_long_se$residence[surv_long_se$residence == "2"] <- "Small city"
surv_long_se$residence[surv_long_se$residence == "3"] <- "Medium-size city"
surv_long_se$residence[surv_long_se$residence == "4"] <- "Large city"
surv_long_se$residence[surv_long_se$residence == "5"] <- "Very large city"


surv_long_se %>% 
  filter(covid_survey == "change_financial",
         residence != "." ) %>% 
  group_by(residence, score) %>% 
  summarise(count = n()) %>% 
  mutate(score = reorder_within(score, count, residence)) %>% 
  ungroup() %>% 
  ggplot(aes(x = score,
             y = count,
             fill = residence)) +
  geom_col() +
  facet_wrap(vars(residence),
             scales = "free") +
  scale_x_reordered() +
  scale_fill_brewer(palette = "Set2") +
  geom_text(aes(label = count, fill = NULL, vjust = 1.2),
            size = 2.5,
            colour = "white") +
  theme_light() +
  theme(legend.position = "none") +
  labs(x = "Answer",
       y = "Total Count",
       title = "In the past month, have you experienced any negative consequences \nto your employment or financial situation due to the spread of COVID-19?",
       fill = "Answer",
       subtitle = "Year: 2020",
       caption = "Answer: 0 = not at all, 1 = to some degree, 2 = to a substantial degree, 3 = to a very high degree \nData Source: Swedish COVID-19 Data Portal") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0))
  
```
#### Behaviour
##### Drinking & Smoking 
```{r}
# alcohol
p1 <- surv_long_se %>% 
  filter(covid_survey == "change_alc_freq",
         score != "." ) %>% 
  group_by(score) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = fct_reorder(score, count),
             y = count,
             fill = score)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("#66c2a5","#66c2a5", "#66c2a5", "#66c2a5", "#66c2a5")) +
  scale_x_discrete(labels = c("much more", "slightly more", "much less", "slightly less", "no change")) +
  scale_y_continuous(breaks=seq(0, 500, 100)) +
  geom_text(aes(label = count, fill = NULL, hjust = -0.1),
            size = 3,
            colour = "#66c2a5") +
  theme_light() +
  labs(x = "Answer",
       y = "Total Count",
       title = "Did you drink alcohol less or more often in the past month?",
       subtitle = "Year: 2020") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0),
        legend.position = "none",
        axis.text.y = element_text(size = 8))

# smoke
p2 <- surv_long_se %>% 
  filter(covid_survey == "change_smoke",
         score != "." ) %>% 
  group_by(score) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = fct_reorder(score, count),
             y = count,
             fill = score)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("#fc8d62","#fc8d62", "#fc8d62", "#fc8d62", "#fc8d62", "#fc8d62")) +
  scale_x_discrete(labels = c("much more", "slightly less", "slightly more", "much less", "no change", "do not consume")) +
  scale_y_continuous(breaks=seq(0, 700, 100)) +
  geom_text(aes(label = count, fill = NULL, hjust = -0.1),
            size = 3,
            colour = "#fc8d62",
            angel = 90) +
  theme_light() +
  theme(legend.position = "none",
        axis.text.y = element_text(size = 8)) +
  labs(x = "Answer",
       y = "Total Count",
       title = "Did you smoke less or more often in the past month?",
       subtitle = "Year: 2020",
       caption = "Data Source: Swedish COVID-19 Data Portal") +
  theme(plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0))


(p1 / p2 ) + plot_annotation(tag_levels = 'A')
```

##### Use of Cannabis & Illegal Drugs

```{r}
# cannabis
p3 <- surv_long_se %>% 
  filter(covid_survey == "change_cannabis",
         score != "." ) %>% 
  group_by(score) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = fct_reorder(score, count),
             y = count,
             fill = score)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("#8da0cb","#8da0cb", "#8da0cb", "#8da0cb", "#8da0cb", "#8da0cb")) +
  scale_x_discrete(labels = c("slightly less", "much more", "much less", "slightly more", "no change", "do not consume")) +
  geom_text(aes(label = count, fill = NULL, hjust = -0.1),
            size = 3,
            colour = "#8da0cb") +
  theme_light() +
  labs(x = "Answer",
       y = "Total Count",
       title = "Did you consume cannabis less or more often in the past month?",
       subtitle = "Year: 2020") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0),
        legend.position = "none",
        axis.text.y = element_text(size = 8))


# drugs
p4 <- surv_long_se %>% 
  filter(covid_survey == "change_illdrugs",
         score != "." ) %>% 
  group_by(score) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = fct_reorder(score, count),
             y = count,
             fill = score)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("#e78ac3","#e78ac3", "#e78ac3", "#e78ac3", "#e78ac3", "#e78ac3")) +
  scale_x_discrete(labels = c("slightly more", "much less", "no change", "do not consume")) +
  geom_text(aes(label = count, fill = NULL, hjust = -0.1),
            size = 3,
            colour = "#e78ac3") +
  theme_light() +
  labs(x = "Answer",
       y = "Total Count",
       title = "Did you use illegal drugs less or more often in the past month?",
       subtitle = "Year: 2020",
       caption = "Data Source: Swedish COVID-19 Data Portal") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0),
        legend.position = "none",
        axis.text.y = element_text(size = 8))

(p3 / p4) + plot_annotation(tag_levels = 'A')
```


### Current Vaccination Status

```{r}
# remove "w" in string
vacc_se$YearWeekISO <- gsub("[[:alpha:]]", "", vacc_se$YearWeekISO)

# add month column
vacc_se$month <- strsplit(vacc_se$YearWeekISO, "-") 

vacc_se$month <- sapply(vacc_se$month,function(x) {
  year_week <- unlist(x)
  year <- year_week[1]
  week <- year_week[2]
  start_date <- as.Date(paste0(year,'-01-01'))
  date <- start_date+weeks(week)
  return (as.character(date))
})

vacc_se$month <- month(vacc_se$month)

vacc_se$month <- ifelse(str_starts(vacc_se$YearWeekISO, "2020"), "12", vacc_se$month)

vacc_se <- vacc_se %>% 
  separate(YearWeekISO, c("year", "week"), "-") %>% 
  relocate(month, .after = week) 

vacc_se$yearMonth <- paste(vacc_se$year, vacc_se$month, sep = "-")

```

#### Fully Vacinated Numbers

<style>
.html-widget {
    margin: auto;
}
</style>

```{r}
vacc_se_long <- vacc_se %>% 
  pivot_longer(cols = c("FirstDose", "SecondDose"),
               names_to = "dose",
               values_to = "entry")


plot_vacc_1 <- vacc_se_long %>% 
  rename(Month = yearMonth) %>% 
  filter(ReportingCountry == "SE",
         TargetGroup == "ALL") %>% 
  group_by(Month, dose) %>% 
  summarise(count = sum(entry)) %>% 
  ggplot(aes(x = Month,
             y = count,
             group = dose,
             fill = dose)) +
  geom_area(alpha = 0.8, size = 0.5, colour = "white") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE),
                     breaks=seq(0, 6000000, 1000000)) +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62")) +
  theme_light() +
  labs(y = "Number of Doses Administered",
       title = "Trend of First and Second Dose Vaccine Administered",
       fill = "Dose",
       caption = "European Centre for Disease Prevention and Control") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size = 8))

ggplotly(plot_vacc_1) %>% 
       layout(title = list(text = paste0("Trend of First and Second Dose Vaccine Administered",
                                    "<br>",
                                    "<sup>",
                                    "Year: Dec 2020 - Sep 2021",
                                    "</sup>")),
           annotations = list(x = 1, y = -0.5,
                              text = "Data Source: European Centre for Disease Prevention and Control",
                              showarrow = F,
                              font=list(size=8)))

```



```{r}
plot_vacc_2 <- vacc_se %>% 
  filter(ReportingCountry == "SE",
         TargetGroup %in% c("Age18_24", 
                            "Age25_49", 
                            "Age50_59", 
                            "Age60_69", 
                            "Age70_79", 
                            "Age80+")) %>% 
  rename(Month = yearMonth) %>% 
  group_by(TargetGroup, Month) %>%
  summarise(count = sum(SecondDose)) %>%
  ungroup() %>% 
  ggplot(aes(x = Month,
             y = count,
             group = TargetGroup,
             colour = TargetGroup)) +
  geom_line() +
  geom_point(size = 0.6) +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE),
                     limits = c(0, 1200000),
                     breaks=seq(0, 1400000, 100000)) +
  scale_colour_brewer(palette = "Set2",
                      labels = c("Age 18-24",
                                 "Age 25-49",
                                 "Age 50-59",
                                 "Age 60-69",
                                 "Age 70-79",
                                 "Age 80+")) +
  theme_light() +
  labs(y = "Number of Second Doese Vaccine Administered",
       title = "Trend of Fully Vaccinated Numbers, by Age",
       colour = "Age Group",
       caption = "European Centre for Disease Prevention and Control") +
  theme(plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size = 8))

ggplotly(plot_vacc_2) %>% 
       layout(title = list(text = paste0("Trend of Fully Vaccinated Numbers, by Age",
                                    "<br>",
                                    "<sup>",
                                    "Year: Dec 2020 - Sep 2021",
                                    "</sup>")),
           annotations = list(x = 1, y = -0.5,
                              text = "Data Source: Swedish COVID-19 Data Portal",
                              showarrow = F,
                              font=list(size=8)))

```




```{r}
vacc_se$Vaccine[vacc_se$Vaccine == "COM"] <- "Pfizer"
vacc_se$Vaccine[vacc_se$Vaccine == "MOD"] <- "Moderna"
vacc_se$Vaccine[vacc_se$Vaccine == "AZ"] <- "AstraZenecar"
vacc_se$Vaccine[vacc_se$Vaccine == "UNK"] <- "Unknown"


vacc_se %>% 
  filter(ReportingCountry == "SE",
         TargetGroup == "ALL") %>% 
  group_by(Vaccine) %>% 
  summarise(count = sum(SecondDose)) %>% 
  ggplot(aes(area = count,
             fill = Vaccine,
             label = paste0(Vaccine, "\n", prettyNum(count, big.mark = ",")),
             subgroup = Vaccine)) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "white", size = 1) +
  geom_treemap_text(color = "white", size = 18, min.size = 1) +
  scale_fill_brewer(palette = "Set2") +
  labs(fill = "Vaccine",
       title = "Type of Vaccines Adminstered in Sweden",
       subtitle = "Year: Dec 2020 - Sep 2021",
       caption = "Data Source: Swedish COVID-19 Data Portal") +
  theme(axis.text.y = element_text(size = 6),
        plot.caption.position = "panel",
        plot.caption = element_text(hjust = 0)) 

```


```{r}

```






## Reference

ECDC, European Centre for Disease Prevention and Control. (2021, September, 9). "Data on COVID-19 vaccination in the EU/EEA", <https://www.ecdc.europa.eu/en/publications-data/data-covid-19-vaccination-eu-eea>








